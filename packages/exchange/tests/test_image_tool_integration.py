# import pytest
from exchange.exchange import Exchange
from exchange.message import Message
from exchange.content import ImageUrl, Text
from exchange.providers import Provider
from exchange.moderators import Moderator, ContextTruncate
from exchange.providers.openai import OpenAiProvider


def test_describe_image_url():
    image_url = ImageUrl(url="https://picsum.photos/id/1/200/200")  
    user_message = Message(role="user", content=["Describe the image: ", image_url])                                                                                                                                                                      
    ex = Exchange(
        provider=OpenAiProvider.from_env(),
        model="gpt-4o",
        system="You are a helpful assistant.",
        tools=[],
    )
    ex.add(user_message)
    res = ex.reply()
    assert "laptop" in res.content[0].text

def test_image_comparison_url_and_data():
    image_url_base64 = ImageUrl(url="data:image/jpeg;base64,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")
    image_url = ImageUrl(url="https://picsum.photos/id/1/200/200")  
    user_message = Message(role="user", content=["Are these images the same? ", image_url_base64, image_url ])                                                                                                                                                                      
    ex = Exchange(
        provider=OpenAiProvider.from_env(),
        model="gpt-4o",
        system="Reply with yes or no.",
        tools=[],
    )
    ex.add(user_message)
    res = ex.reply()
    assert "yes" in res.content[0].text.lower()
